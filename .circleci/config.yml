version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:latest
      - image: circleci/postgres:latest
        environment:
          POSTGRES_DB: poestatustest
          POSTGRES_USER: poe

    working_directory: /tmp/{{ORG_NAME}}/{{REPO_NAME}}
    steps:
      - checkout
      - setup_remote_docker
      run:
        command: |
          echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
        environment:
          GCLOUD_SERVICE_KEY: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicGVyc29uYWwtazhzLTI0NzUxOSIsCiAgInByaXZhdGVfa2V5X2lkIjogIjM5MjMzNGZlNGU4YTA2NGRhODBjOWIyZDI3YTRjNGE3ODRiYzUzZmQiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ3gzYm9qZURRVjlYNlZcblNGMXBDZVYzR2dpeEgveHBjc0ptMEZTZ1BEVkV1QndIL2dTQlBacEVlT0FVcHB4bjU4WnBKazlxdzA3Qm9hSElcbkpxY3RrZjNMYTNBb3hYUmpPdnBnNnB5WnkyMzlFd3gxTkRMb3hMWG5tRC8xWEJiYlV6MzE5blozMjRTS1N0eStcblBsRDNKSEhmL0J6dVVjYnY3d3RTVG52bk45ZmR3VGJwTi9GT3dhZDQzakhLS04rbTBza1lSRmNPMmlpMVh6T0RcblhTZjVOdHVWbDJlTGJuTDFKdEFsK2ErOGtDZ2NLWUFWZkNPZUpvK2hpcmw2cUQ4UUxGVnREWW9JanJEbFBWSDhcbkdjQVpCWmwySnBRMXFLdElKUnNNWlBrbmR4ekV2ZHhtSkh5QnhDNS9jcVB2Z3Riei9jckVwdVVvQTRCZVBkREZcblJLamt5OGlUQWdNQkFBRUNnZ0VBUTNlQ2NvL1cyZmw3NFc1SW1GNDdueGpOOFRuYnliZlJDNlM4Wk9kUm9WWmdcbnM1dGo1QTRVNVNJZ2hWVEpnUlJHaTM0UG84U2ZyQXorUytoMWczQ2NIendLbUR5RnNGb2Z2UUZoRTJrNXVFUXdcbmRvaXRRdVBTeUIxVkxXR1gvZXV1Vmd6OTFPcjhkR1IvSk42SVlhWitWMkxQS29yMGRmQnJqL1hiUTlKSDNJSWFcblhKS3h0Z1Z6VWJnZnVTeDYwdm5QUmlyUHQyTDBHdEtVQUxVRGZrYjhjcXBscnZOQmJjbmdMaWhEZkxpamFtb3ZcbmpUWkJaKzhWczJqUDdBNXF6WGF3SkNBcm1vNWdORkMyZDUyYTZqN0hvR2pmUzFEeHhJV285dUlwSlBZb29BV1dcblZRbllBYVVOOXRVcXFVZ01HTWFrN0UwaWd5aWFBZmdWTFo2T0RnVEd5UUtCZ1FEbGpOZmFBSVhrbWVIRWZVSnFcbnNkeEoyR3I3KzcxZ3NYbDJ4d0lFaVJoMjlrcG5yeU1Ed0VEcTE3ckRoWk5vb1YxS0JpeWo2RUxDbFgzQ0NIYStcblBvdE9GUFp0cXp0UytyVVpPdGMyQkRlV2RrRWN0RmVkcUpldXpUa2NKeU9ueE40QnlLWlRSZEdCS2NZeUxabVZcbjZrVDFPOVdEY1JqQnJic3JOTHc1cDlFeXR3S0JnUURHWEZWbUVYa2RHZUJQQXJzNXZQeDg3QnFxMmhNaklvdzZcblpucnFqd1N4SHJoMDBwTHJkbnUrVVJnQ2lvdHRMVWNoSVVoZHdYcjlxTUwyRHFOcFp2b2ZGK2pRTzlEZlBoeTRcbjVwN2dkbzZveEE4eW0rb0NmeHZzTklMME1QaVVxZ3hML1pwZDl6S0UyQUU1TDN4WkUxVXhaM2pjZnRwaEtBeXVcblFsenJEbkdOQlFLQmdRQ2xhOFh4ZUFjRklrK3NSWWdqVTJFb1ppbFN4YXRIangyMUZ0ekJYL3FkWUFkbWlMTjJcbjlJalRzL3NIQTYraTZ3WkxYZisxYnA4TmtxVTV1dGUzYVdNQ05lRVFUeUZGUHg1YXZDaHk2TDhXVXNuQlljVHhcbi9KaXlnM253YTlRcUJwam1PQzZFUEFBcVVHeGZwTFRWY0NtWmdERHh0QUxmTDg5OTUxYnRSWjVnS1FLQmdGdWJcbkpLMUFnSWhaL09kQVFhckdobXhDdFlZVnRDVFR2YUx5MU8waUkyNlEyMnJJSEtXMVVDeHlVdjVKY1Y1NFBKTW1cblJiOVdyVEFjRWYyRWdSOGFPWVRHaS9RdXk2VnRqK0lzVDA4bU1YZnJJNEdoMDQ1WG1WT2FaS2ZWUGRlYU9KZVhcbmhRVEVOb1ozSXdsL3pwTnNoRG1PcVpoYTFRdHRiWDNFbEJqUjBNcnBBb0dBRkxIM2R1NnpxL3YxbGdxU3dvK0dcbnpodGdnZDJ3ZFk3WENkT2x1eHF5NGd3R05WbUxxUVZZdGQ0TjVncWprbUxrc3JsaVpZQzgzaGtRM1dwWHg2MmJcbk5Sd2VSOGJ6TFF1VDdHbHZLRDl2Nzg1eUFCYUhNMW5tKzRSa1ZtbWY1OGMzbW8wUVh6czlOT0ZvTVdjT3gvL1Bcbml2cWlxN1IxcFJwS0hTdjBvMktrR1BVPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImNpcmNsZWNpQHBlcnNvbmFsLWs4cy0yNDc1MTkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTEzMDIyMTY3ODgwOTQzMzQwMzkxIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9jaXJjbGVjaSU0MHBlcnNvbmFsLWs4cy0yNDc1MTkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K
          GCLOUD_PROJCET_ID: personal-k8s-247519
          GOOGLE_COMPUTE_ZONE: us-central1-a
      - run: ./.circleci/deps.sh
      - run: go get
      - run:
          command: make clean test
          environment:
            SKIP_PING: yes
            TEST_DATABASE_URL: postgres://poe@localhost:5432/poestatustest?sslmode=disable
      - run: make docker-build docker-push
